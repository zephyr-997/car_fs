# 调参方案



## 实际调节主要参数

### 1. 赛道类型识别阈值
这是最优先需要调节的参数，因为它直接影响系统对不同赛道特征的识别准确性：

**// 十字路口识别阈值**

```c
normalized_data[SENSOR_HML] > 60.0f && normalized_data[SENSOR_HMR] > 60.0f && 
normalized_data[SENSOR_HC] > 70.0f && 
normalized_data[SENSOR_HL] < 30.0f && normalized_data[SENSOR_HR] < 30.0f &&
sum_vertical > 80.0f

// 环岛识别阈值
normalized_data[SENSOR_HL] > 80.0f && normalized_data[SENSOR_HR] < 20.0f
// 或
normalized_data[SENSOR_HR] > 80.0f && normalized_data[SENSOR_HL] < 20.0f

// 直角弯道识别阈值
normalized_data[SENSOR_HL] > 65.0f && normalized_data[SENSOR_VL] > 65.0f && 
normalized_data[SENSOR_HR] < 25.0f && normalized_data[SENSOR_VR] < 25.0f
// 或
normalized_data[SENSOR_HR] > 65.0f && normalized_data[SENSOR_VR] > 65.0f && 
normalized_data[SENSOR_HL] < 25.0f && normalized_data[SENSOR_VL] < 25.0f
// 以及
normalized_data[SENSOR_HC] < 40.0f && 
signal_strength > 30.0f && signal_strength < 60.0f
```



**调试方法：**
    使用串口输出识别到的赛道类型（track_type）和各电感的归一化值
    在各种赛道类型上手动推动小车，观察输出
    若经常出现误识别，适当修改阈值

### 2. 电感权重配置
各赛道类型的电感权重是影响寻迹性能的关键参数：

```c
// 直道权重
weight_outer = 0.25f;
weight_middle = 0.45f;
weight_center = 0.1f;
weight_vertical = 0.2f;

// 弯道权重
weight_outer = 0.4f;
weight_middle = 0.3f;
weight_center = 0.1f;
weight_vertical = 0.2f;

// 直角弯道权重
weight_outer = 0.45f;
weight_middle = 0.25f;
weight_center = 0.05f;
weight_vertical = 0.25f;
```

**调试方法：**
    从基础权重开始，先调整普通道路的权重配置
    小车在直道上跑偏时，增加中心电感和中间电感权重
    小车过弯太晚，增加外侧电感权重
    小车过直角弯道不够快，可增加weight_outer和weight_vertical



### 3. 滤波和位置变化限制参数 

这些参数直接影响小车的响应性能和稳定性：

```c
// 滤波系数（越大响应越快，但可能更抖动）
filter_param = 0.4f; ~ 0.7f

// 位置变化率限制
max_change_rate = 8; ~ 18
```

**调试方法：**
    小车运行不稳定、抖动明显：降低filter_param和max_change_rate
    小车反应迟钝：提高filter_param和max_change_rate
    直角弯道过不了：提高直角弯道的max_change_rate（最高可到25）



### 4. 中心电感修正参数
中心电感的修正逻辑可以提高直道行驶的稳定性：

```c
// 修正触发阈值
center_value > 50.0f

// 修正系数计算
center_correction = (center_value - 50.0f) / 50.0f * 0.3f;
```

调试方法：
    直道行驶不稳定：提高修正系数（如0.4f）
    弯道过弯受阻：降低修正系数或提高触发阈值

### 5. 信号强度阈值
调节不同信号强度下的权重配置：
// 信号强度判定阈值
signal_strength > 70.0f  // 直道阈值
signal_strength < 30.0f  // 弯道阈值

调试方法：
    车在直道上的行为和弯道行为不一致：调整这些阈值
    通过串口输出信号强度，在各赛道上测量实际值，根据实测值调整

### 6. 出赛道保护阈值
如果需要防止小车出赛道，可调整保护阈值：
// 判断是否脱离赛道的阈值
uint16 threshold = 175; 

## 实际调试步骤建议
1. 调试基本电感值：
    * 先用串口监控七个电感的原始和归一化值，确保都正常工作
    * 在赛道各部分手动推车，记录各种赛道情况下的电感特征
2. 调试赛道类型识别：
    * 修改赛道类型阈值，确保能正确识别十字、环岛和直角弯
    * 通过串口输出track_type验证识别正确性
3. 调试直道性能：
    * 先将小车放在直道上低速运行
    * 调整weight_center和中心电感修正参数，使小车保持中线行驶
4. 调试弯道性能：
    * 提高速度，调整普通弯道的权重使小车平稳过弯
    * 特别关注weight_outer和filter_param参数
5. 调试直角弯道：
    * 重点调整直角弯道的识别条件和权重参数
    * 尤其要调整max_change_rate确保能快速响应
6. 调试特殊赛道：
    * 针对赛道上的特殊部分（如十字路口、环岛），单独测试和优化
7. 全局优化：
    * 在完整赛道上测试，微调所有参数使整体性能最优   



## 实际调试步骤

调整 weight_outer、weight_middle 和 weight_vertical 这三个权重值是优化电磁循迹性能的关键步骤。这些权重的和不一定必须为1。它们的作用是调整不同电感组（外侧、中间、纵向）差比和信号在最终位置计算中的相对重要性。

以下是如何根据不同赛道元素来调节这三个权重值的思路和建议：

理解每个权重的作用：

- weight_outer (外侧横向电感 HL, HR 的权重):

  - 对外侧的偏移非常敏感。

  - 在大半径弯道或需要感知赛道较宽范围变化时比较重要。

  - 权重过高可能导致在直道上对微小扰动过于敏感，产生晃动；权重过低可能导致入弯迟钝。

- weight_middle (中间横向电感 HML, HMR 的权重):

  - 对靠近中心线的偏移比较敏感。

  - 在直道行驶和小半径弯道中通常起主要作用，帮助车辆精确保持在赛道中心。

  - 权重过高可能使车辆在弯道中过于贴近内侧，难以处理大角度弯；权重过低可能导致直道稳定性下降。

- weight_vertical (纵向电感 VL, VR 的权重):

  - 对车辆进入或离开弯道（特别是急弯、直角弯、环岛入口/出口）时的姿态变化和前后差异敏感。

  - 在判断弯道类型、入弯和出弯的过渡阶段以及环岛等元素中非常重要。

  - 可以帮助车辆更早地感知弯道并做出响应，或者在环岛中提供额外的循迹信息。

  - 权重过高可能导致对路面细微的前后磁场变化过度反应；权重过低则可能削弱其在特殊元素中的辅助判断能力。

### 调节策略建议：

1. 基础原则：

   - 从直道开始调： 首先在直道上调整，让车辆能够稳定居中行驶。此时 weight_middle 通常占据主导地位。

   - 逐步引入弯道： 然后再逐步测试小半径弯、大半径弯、直角弯等，相应调整其他权重。

   - 少量多次调整： 每次调整一个参数或一小组关联参数，观察效果，避免一次性大幅度修改导致难以判断问题。

   - 记录参数与现象： 详细记录每次参数修改的内容以及车辆在不同赛道元素上的表现，便于分析和回溯

2. 针对不同赛道元素的调节侧重点：

- 直道 (WEIGHT_STRAIGHT):

  - 主要目标：稳定居中，抑制晃动。

  - weight_middle: 相对较高，保证循线精度。

  - weight_outer: 相对较低，避免对直道上的微小噪声过于敏感。

  - weight_vertical: 通常较低，除非直道上有特殊的前后磁场变化需要感知。

  - *示例初始值 (参考您代码中的值，可以作为起点)*: outer: 0.15, middle: 0.45, vertical: 0.15 (您代码中直道 middle 是 0.45，这里保持一致)

- 直角弯道 (WEIGHT_RIGHT_ANGLE):

  - 主要目标：迅速响应，准确切弯，防止冲出或撞内角。

  - weight_vertical: 可以适当提高，帮助提前感知弯道入口和判断转弯时机。

  - weight_outer: 可能需要提高，以更好地感知弯道外侧的引导线。

  - weight_middle: 可能会适当降低，因为在急弯中，车辆姿态变化大，过于依赖中间电感可能导致判断滞后。

  - *可以考虑的方向*: 增加 weight_vertical 和 weight_outer 的比例。

- 十字圆环 (WEIGHT_CROSS):

  - 主要目标：平稳进入、通过和离开路口/圆环，准确识别路径。

  - 这是一个复杂元素，可能需要所有电感的综合信息。

  - weight_vertical: 对于识别进入和离开圆环的状态可能比较重要。

  - weight_outer 和 weight_middle: 需要根据圆环的具体形状和引导线布局来平衡。如果圆环较大，weight_outer 可能更重要；如果引导线靠近中心，weight_middle 可能更重要。

  - 您的预设值：outer: 0.3, middle: 0.4, vertical: 0.1。这个配置中，weight_middle 依然较高，说明可能期望在十字路口中心区域也保持较好的循中能力。

- 环岛 (WEIGHT_ROUNDABOUT):

  - 主要目标：平滑入环、稳定环内循迹、准确出环。

  - weight_vertical: 在入环和出环时非常关键，可以帮助判断车辆是否完全进入或离开环岛。

  - weight_outer: 在环岛内循迹时，对外侧引导线的感知很重要，可能需要较高权重。

  - weight_middle: 在环岛内，如果引导线清晰且靠近中心，也有一定作用，但相对外侧和纵向可能次要一些。

  - 您的预设值：outer: 0.5, middle: 0.3, vertical: 0.1。这里显著提高了 weight_outer，符合环岛循迹的需求。weight_vertical 相对较低，可能更多依赖赛道类型判断逻辑中的具体电感值来控制入环出环状态，而不是单靠位置计算中的权重。

关于权重之和：

- 不强制为1：这三个权重是相对的。如果它们的和不为1，最终的 pos 值会相应地被缩放。例如，如果所有权重都加倍，那么在相同 ratio 的情况下，pos 的绝对值也会加倍（在乘以100之前）。

- 影响敏感度：权重的大小共同决定了最终 pos 值对电感信号变化的敏感程度。如果所有权重都偏小，车辆响应会迟钝；如果都偏大，响应会灵敏但也可能过于敏感导致震荡。

- 关注相对比例：更重要的是这三个权重之间的相对大小关系，它决定了哪组电感对当前位置计算的贡献更大。

- 调整方法：

- 可以先确定一个大致的总和范围，例如，你可以尝试让它们的和大致在 0.5 到 1.5 之间波动，然后在这个总和下调整它们的相对比例。

- 也可以固定其中一个（例如 weight_middle），然后调整另外两个的比例。

其他需要配合调整的参数：

- filter_param (滤波系数)：影响位置输出的平滑度。权重调整后，如果车辆反应过于灵敏或迟钝，也需要调整此参数。

- max_change_rate (最大变化率)：限制位置输出的突变。如果调整权重后车辆转向过快或过慢，此参数也需要匹配。

- 赛道类型判断逻辑：权重是为特定赛道类型服务的，因此准确的赛道类型判断是权重发挥作用的前提。如果赛道类型判断不准，再好的权重也可能用错地方。

- PID 控制参数：最终的循迹效果是电磁位置计算和电机PID控制共同作用的结果。调整了电磁循迹的权重后，可能也需要重新调整方向环的PID参数。

调试流程建议：

1. 备份参数：在进行大幅度调整前，一定备份你当前觉得效果尚可的参数。
2. 单一变量原则：尽量一次只修改一个权重或一小组相关的权重，观察效果。
3. 串口/显示屏调试：利用串口打印或显示屏显示归一化的电感值、各个 ratio 值、当前赛道类型、计算出的 pos 值等，帮助你理解权重是如何影响最终结果的。
4. 实际跑车观察：参数的优劣最终要通过实际跑车来检验。观察车辆在不同赛道部分的姿态、平稳性、过弯的准确性和速度。

这是一个需要耐心和大量实验的迭代过程。没有绝对的“最佳”参数，只有最适合当前赛车机械结构、传感器特性和赛道特点的参数组合。



## 实际调参记录



### 十字圆环

速度：30

* 测试1

  * outer：0.17
    * middle：0.30

  * vertical：0.10

  * 效果：环中右上角不贴紧，出环时可抓回直线

* 测试2

  * outer：0.3

  * middle：0.4

  * vertical：0.1

  * 效果：环中效果良好，但是出环时方向一直偏，导致来到圆环时方向偏差太大

* 测试3

  * outer：0.06

  * middle：0.4

  * vertical：0.06

  * 效果：环中效果良好，出环方向太偏了，环后一小段距离能抓回直线

* 测试3

  * outer：0.25

  * middle：0.35

  * vertical：0.10

  * 效果：环中效果良好，出环方向太偏了，环后一小段距离能抓回直线但是车头偏右





### 环岛

速度：30

* 测试1

  * outer：0.5
  * middle：0.30

  * vertical：0.10

  * 效果：无法进环
* 测试2

  * outer：0.5
  * middle：0.30

  * vertical：0.10

  * 效果：无法进环
* 测试3（入环出环写死）
  * outer：0.5
  * middle：0.30
  * vertical：0.10
  * 效果：环中太抖
* 测试3（入环出环写死）
  * outer：0.3
  * middle：0.4

  * vertical：0.10

  * 效果：效果改善，但是出环时不能抓紧线，有点偏，应该是收到了outer电感影响较大

* 测试3（入环出环写死）
  * outer：0.15
  * middle：0.4

  * vertical：0.15

  * 效果：效果改善，出环很稳，outer的影响降低
