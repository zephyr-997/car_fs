# car1.0
This is a car project.

  一、代码更改  
    系统会自动记录各电感的最大最小值，初次使用时需要将车放在赛道中心和两边边缘位置移动几次，让系统自动校准各电感  
    的最大最小值。
    normalized_L/LM/RM/R 变量存储归一化后的电感值（范围0-1），可直接用于控制算法。
    position 变量是计算出的位置偏差（范围-100到100），0表示在中心线上，负值表示偏左，正值表示偏右。

    1. 变量声明位置错误：C51编译器要求所有变量必须在函数开始处声明，不能在函数中间随时声明变量。我已修复此问题。
    
    2. 将寻迹算法升级为差比和加权算法
        使用差比和（差值除以和值）代替单纯的加权平均，可以更好地反映电感的相对变化
        差比和的值范围在-1到1之间，更加稳定，不易受电感绝对值变化的影响
        对水平电感和垂直电感分别计算差比和，然后进行加权，可以更好地利用不同电感的特性
        水平电感权重设为0.7，垂直电感权重设为0.3，这样可以更好地反映小车的横向偏移
        您可以根据实际测试情况调整水平电感和垂直电感的权重比例，以获得最佳的循迹效果。
    
    3. 将电磁寻迹相关的代码封装到单独的文件中，使主程序更加简洁
    
    4. 合并电机相关代码
    
    5. 重构电机控制函数并更新相关文件。改变电机PWM功能，接受左占空比和右占空比
    
    6. 使用串口发送数据来使用vofa观看
    
    7. 将电感数据的格式更改为数组和二维数组并移植修改师兄代码
        将均值滤波函数 -> 递推均值滤波
        增加中位值滤波
        数据处理流程：adc采样 → 滤波处理 → result数组 → 归一化处理 → normalized_data数组 → 位置计算
    
    8. 优化归一化函数,改进计算位置（使用自适应差比和加权方法），两级滤波系统效果优秀,归一化和位置数据效果良好
    
    9. 启用pit_timer_ms后异常，检查后发现陀螺仪使用异常导致卡死
    
    10. 将代码更改历史记录到readme.md



二、TIPS:

    可参考函数：
    1. 自适应增益控制：根据位置变化调整灵敏度
    2. 动态阈值调整：根据平均信号强度调整噪声阈值
    3. 电感权重动态调整：根据信号强度动态调整各电感的权重
    4. 后期可以改进check_electromagnetic_protection保护触发函数
    5. 可以了解卡尔曼滤波貌似更高效
    
    滤波方案：两级滤波系统
    原始ADC采样
        ↓
    递推均值滤波 (average_filter)
        ↓
    存入历史数组
        ↓
    中位值滤波 (mid_filter)
        ↓
    最终滤波结果

三、

```
1、重写了pid的代码，通用pid代码加入前馈优化项，转向环加入二次优化项；增量式pid改在函数内进行累加
2、改用串级pid进行调控
3、开启定时器1，用来扫描按键，新增按键代码，按键实测正常
```

