C251 COMPILER V5.60.0,  electromagnetic_tracking                                           29/03/25  23:09:18  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE electromagnetic_tracking
OBJECT MODULE PLACED IN .\Out_File\electromagnetic_tracking.obj
COMPILER INVOKED BY: D:\Software\Keil5\c251v560\C251\BIN\C251.EXE ..\USER\src\electromagnetic_tracking.c XSMALL INTR2 FL
                    -OAT64 WARNINGLEVEL(3) OPTIMIZE(0,SPEED) BROWSE INCDIR(..\CODE;..\USER\inc;..\USER\src;..\seekfree_components;..\seekfree
                    -_libraries;..\seekfree_peripheral;..\libraries) DEBUG PRINT(.\Out_File\electromagnetic_tracking.lst) TABS(2) OBJECT(.\Ou
                    -t_File\electromagnetic_tracking.obj) 

stmt  level    source

    1          #include "electromagnetic_tracking.h"
    2          
    3          
    4          // æ»¤æ³¢åæ•°æ® - ä½¿ç”¨äºŒç»´æ•°ç»„å½¢å¼
    5          // ç¬¬ä¸€ç»´è¡¨ç¤ºç”µæ„Ÿç¼–å·ï¼š0-L, 1-LM, 2-RM, 3-R
    6          // ç¬¬äºŒç»´ä¿ç•™ï¼Œå¯ç”¨äºå­˜å‚¨å†å²æ•°æ®
    7          #define SENSOR_COUNT 4   //ç”µæ„Ÿä¸ªæ•°
    8          #define HISTORY_COUNT 5  //æ»¤æ³¢æ¬¡æ•°
    9          
   10          uint16 adc_fliter_data[SENSOR_COUNT][HISTORY_COUNT]; //æ»¤æ³¢åçš„å€¼
   11          float result[SENSOR_COUNT];         //ç”µå­˜å‚¨æ¯ä¸ªç”µæ„Ÿæ»¤æ³¢åçš„æœ€ç»ˆç»“æœå€¼ï¼ˆå°šæœªå½’ä¸€åŒ–ï¼‰ï¼
             -Œæ˜¯è¿æ¥æ»¤æ³¢å¤„ç†å’Œå½’ä¸€åŒ–å¤„ç†çš„ä¸­é—´å˜é‡
   12          uint16 sum[SENSOR_COUNT][HISTORY_COUNT];              //ç´¯åŠ çš„å’Œ
   13          
   14          
   15          
   16          // é€’æ¨å‡å€¼æ»¤æ³¢ç›¸å…³å‚æ•°
   17          uint16 times = HISTORY_COUNT;  // æ»¤æ³¢æ¬¡æ•°
   18          uint16 i_num = SENSOR_COUNT;  // ç”µæ„Ÿæ•°é‡
   19          
   20          
   21          
   22          // å½’ä¸€åŒ–æ•°æ®
   23          float normalized_L, normalized_LM, normalized_RM, normalized_R;
   24          
   25          // å­˜å‚¨æ¯ä¸ªç”µæ„Ÿçš„æœ€å¤§æœ€å°å€¼ï¼Œç”¨äºåŠ¨æ€æ ¡å‡†
   26          uint16 min_L = 0xFFFF, min_LM = 0xFFFF, min_RM = 0xFFFF, min_R = 0xFFFF;
   27          uint16 max_L = 0, max_LM = 0, max_RM = 0, max_R = 0;
   28          
   29          // ç”µæ„Ÿä½ç½®è®¡ç®—ç›¸å…³å˜é‡
   30          int16 position;
   31          
   32          // ç”µç£ä¿æŠ¤é€»è¾‘å˜é‡
   33          uint8 protection_flag = 0;
   34          
   35          // å·®æ¯”å’Œç®—æ³•ä¸­é—´å˜é‡
   36          float ratio_L_R = 0;
   37          float ratio_LM_RM = 0;
   38          
   39          // åˆå§‹åŒ–ç”µç£ä¼ æ„Ÿå™¨
   40          void electromagnetic_init(void)
   41          {
   42   1          adc_init(ADC_L, 0);
   43   1          adc_init(ADC_LM, 0);
   44   1          adc_init(ADC_RM, 0);
   45   1          adc_init(ADC_R, 0);
   46   1          
   47   1          // åˆå§‹åŒ–äºŒç»´æ•°ç»„
   48   1          uint8 i, j;
*** ERROR C25 IN LINE 48 OF ..\USER\src\electromagnetic_tracking.c: syntax error near 'uint8'
   49   1          for(i = 0; i < SENSOR_COUNT; i++)
*** ERROR C25 IN LINE 49 OF ..\USER\src\electromagnetic_tracking.c: syntax error near 'for'
*** ERROR C25 IN LINE 49 OF ..\USER\src\electromagnetic_tracking.c: syntax error near '='
*** ERROR C25 IN LINE 49 OF ..\USER\src\electromagnetic_tracking.c: syntax error near '<'
*** ERROR C25 IN LINE 49 OF ..\USER\src\electromagnetic_tracking.c: syntax error near '++'
   50   1          {
C251 COMPILER V5.60.0,  electromagnetic_tracking                                           29/03/25  23:09:18  PAGE 2   

   51   1              for(j = 0; j < HISTORY_COUNT; j++)
*** ERROR C25 IN LINE 51 OF ..\USER\src\electromagnetic_tracking.c: syntax error near '='
*** ERROR C25 IN LINE 51 OF ..\USER\src\electromagnetic_tracking.c: syntax error near '<'
*** ERROR C25 IN LINE 51 OF ..\USER\src\electromagnetic_tracking.c: syntax error near '++'
   52   1              {
   53   1                  adc_fliter_data[i][j] = 0;
*** ERROR C109 IN LINE 53 OF ..\USER\src\electromagnetic_tracking.c: illegal constant expression
*** ERROR C109 IN LINE 53 OF ..\USER\src\electromagnetic_tracking.c: illegal constant expression
*** ERROR C144 IN LINE 53 OF ..\USER\src\electromagnetic_tracking.c: 'array': initialization needs curly braces
   54   1                  sum[i][j] = 0;
*** ERROR C109 IN LINE 54 OF ..\USER\src\electromagnetic_tracking.c: illegal constant expression
*** ERROR C109 IN LINE 54 OF ..\USER\src\electromagnetic_tracking.c: illegal constant expression
*** ERROR C144 IN LINE 54 OF ..\USER\src\electromagnetic_tracking.c: 'array': initialization needs curly braces
   55   1                  adc_fliter_data[i][j] = 0;
*** ERROR C109 IN LINE 55 OF ..\USER\src\electromagnetic_tracking.c: illegal constant expression
*** ERROR C109 IN LINE 55 OF ..\USER\src\electromagnetic_tracking.c: illegal constant expression
*** ERROR C53 IN LINE 55 OF ..\USER\src\electromagnetic_tracking.c: redefinition of 'adc_fliter_data'
*** ERROR C144 IN LINE 55 OF ..\USER\src\electromagnetic_tracking.c: 'array': initialization needs curly braces
   56   1              }
*** ERROR C25 IN LINE 56 OF ..\USER\src\electromagnetic_tracking.c: syntax error near '}'
   57   1          }
   58   1      }
   59   1      
   60   1      //-----------------------------------------------------------------------------
   61   1      // @brief   å¾—åˆ°adcçš„å€¼
   62   1      // @param   æµ‹çš„ADC/ç”µæ„Ÿåºå·
   63   1      // @return  æµ‹å‡ºçš„adcå€¼
   64   1      // @author  hjx
   65   1      // Sample usage:get_adc(1)
   66   1      //-----------------------------------------------------------------------------
   67   1      uint16 get_adc(uint16 i)
   68   1      {
   69   2        switch(i){
   70   3          case 1:
   71   3            return adc_once(ADC_L, ADC_10BIT);
   72   3          
   73   3          case 2:
   74   3            return adc_once(ADC_LM, ADC_10BIT);
   75   3          
   76   3          case 3:
   77   3            return adc_once(ADC_RM, ADC_10BIT);
   78   3          case 4:
   79   3            return adc_once(ADC_R, ADC_10BIT);
   80   3          default:
   81   3            return 0;
   82   3        }
   83   2      }
   84   1      
   85   1      //-----------------------------------------------------------------------------
   86   1      // @brief   é€’æ¨å‡å€¼æ»¤æ³¢
   87   1      // @param   æ— 
   88   1      // @return  æ— 
   89   1      // @author  zp
   90   1      // Sample usage: average_filter();
   91   1      //-----------------------------------------------------------------------------
   92   1      static uint16 filter_index = 0;  // é€’æ¨æ¬¡æ•°è®¡æ•°å™¨
   93   1      static uint8 is_initialized = 0; // åˆå§‹åŒ–æ ‡å¿—,åªåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶è¿›è¡Œå¤šæ¬¡é‡‡æ ·,åç»­è°ƒç
             -”¨æ—¶ä½¿ç”¨çœŸæ­£çš„é€’æ¨ç®—æ³•
   94   1      uint16 j = 0;
*** ERROR C53 IN LINE 94 OF ..\USER\src\electromagnetic_tracking.c: redefinition of 'j'
   95   1      
   96   1      void average_filter(void)
   97   1      {
   98   2          uint16 a = 0, b = 0;
   99   2          
  100   2          // æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ–
C251 COMPILER V5.60.0,  electromagnetic_tracking                                           29/03/25  23:09:18  PAGE 3   

  101   2          if (!is_initialized)
  102   2          {
  103   3              // é‡ç½®ç´¯åŠ å™¨
  104   3              for(a = 0; a < i_num; a++)
  105   3              {
  106   4                  sum[a][0] = 0;
*** ERROR C72 IN LINE 106 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  107   4              }
  108   3              
  109   3              // å‰å‡ æ¬¡é‡‡é›†ï¼Œç´¯ç§¯è¶³å¤Ÿçš„æ•°æ®
  110   3              for(filter_index = 0; filter_index < times; filter_index++)
  111   3              {
  112   4                  for(b = 0; b < i_num; b++)
  113   4                  {
  114   5                      sum[b][0] += get_adc(b+1);  // é‡‡é›†ä¸€æ¬¡ADCå¹¶ç´¯åŠ 
*** ERROR C72 IN LINE 114 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  115   5                  }
  116   4                  delay_us(5); // æ·»åŠ çŸ­æš‚å»¶æ—¶æé«˜é‡‡æ ·ç¨³å®šæ€§
  117   4              }
  118   3              
  119   3              // è®¡ç®—åˆå§‹å¹³å‡å€¼
  120   3              for(a = 0; a < i_num; a++)
  121   3              {
  122   4                  adc_fliter_data[a][0] = sum[a][0] / times;  // æ±‚å¹³å‡
*** ERROR C72 IN LINE 122 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 122 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  123   4                  result[a] = adc_fliter_data[a][0];
*** ERROR C72 IN LINE 123 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  124   4              }
  125   3              
  126   3              is_initialized = 1; // æ ‡è®°åˆå§‹åŒ–å®Œæˆ
  127   3          }
  128   2          else  // å·²åˆå§‹åŒ–ï¼Œæ‰§è¡Œé€’æ¨å‡å€¼æ»¤æ³¢
  129   2          {
  130   3              for(a = 0; a < i_num; a++)
  131   3              {
  132   4                  // é€’æ¨å‡å€¼æ»¤æ³¢æ ¸å¿ƒç®—æ³•ï¼šå‡å»å¹³å‡å€¼ï¼ŒåŠ ä¸Šæ–°å€¼ï¼Œé‡æ–°è®¡ç®—å¹³å‡å€¼
  133   4                  sum[a][0] -= sum[a][0] / times;         // æ¯æ¬¡å»é™¤å¹³å‡å€¼çš„è´¡çŒ®
*** ERROR C72 IN LINE 133 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 133 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  134   4                  sum[a][0] += get_adc(a+1);              // åŠ ä¸Šæ–°å€¼
*** ERROR C72 IN LINE 134 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  135   4                  adc_fliter_data[a][0] = sum[a][0] / times;  // æ±‚æ–°çš„å¹³å‡å€¼
*** ERROR C72 IN LINE 135 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 135 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  136   4                  result[a] = adc_fliter_data[a][0];      // ä¿å­˜ç»“æœ
*** ERROR C72 IN LINE 136 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  137   4              }
  138   3          }
  139   2      }
  140   1      
  141   1      
  142   1      //-----------------------------------------------------------------------------
  143   1      // @brief   ä¸­ä½å€¼æ»¤æ³¢ï¼Œå°†æ¯ä¸ªç”µæ„Ÿçš„ä¸­ä½æ•°ä½œä¸ºç»“æœ
  144   1      // @param   æ— 
  145   1      // @return  æ— 
  146   1      // @author  ZP
  147   1      // Sample usage: mid_filter();
  148   1      //-----------------------------------------------------------------------------
  149   1      static uint8 mid_initialized = 0;  // ä¸­ä½å€¼æ»¤æ³¢åˆå§‹åŒ–æ ‡å¿—
  150   1      static uint16 sample_count = 0;    // é‡‡æ ·è®¡æ•°å™¨
  151   1      
  152   1      void mid_filter(void)
  153   1      {
  154   2          uint16 temp = 0, a = 0, t = 0;
  155   2          uint16 mid_index = 0;
C251 COMPILER V5.60.0,  electromagnetic_tracking                                           29/03/25  23:09:18  PAGE 4   

  156   2          
  157   2          // è°ƒç”¨å‡å€¼æ»¤æ³¢è·å–æ–°çš„é‡‡æ ·å€¼
  158   2          average_filter();
  159   2          
  160   2          // å¦‚æœå°šæœªåˆå§‹åŒ–å®Œæˆ
  161   2          if (!mid_initialized)
  162   2          {
  163   3              // å°†å½“å‰æ»¤æ³¢ç»“æœå­˜å…¥å†å²æ•°ç»„
  164   3              for(a = 0; a < i_num; a++)
  165   3              {
  166   4                  adc_fliter_data[a][sample_count] = adc_fliter_data[a][0];
*** ERROR C72 IN LINE 166 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 166 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  167   4                  result[a] = adc_fliter_data[a][0];
*** ERROR C72 IN LINE 167 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  168   4              }
  169   3              
  170   3              sample_count++;
  171   3              
  172   3              // å½“é‡‡é›†åˆ°è¶³å¤Ÿæ ·æœ¬æ—¶ï¼Œæ ‡è®°åˆå§‹åŒ–å®Œæˆ
  173   3              if (sample_count >= times)
  174   3              {
  175   4                  mid_initialized = 1;
  176   4                  sample_count = 0;  // é‡ç½®è®¡æ•°å™¨ç”¨äºå¾ªç¯ç¼“å†²
  177   4              }
  178   3          }
  179   2          else  // å·²åˆå§‹åŒ–ï¼Œæ‰§è¡Œä¸­ä½å€¼æ»¤æ³¢
  180   2          {
  181   3              // æ›´æ–°å†å²æ•°æ®æ•°ç»„
  182   3              for(a = 0; a < i_num; a++)
  183   3              {
  184   4                  adc_fliter_data[a][sample_count] = adc_fliter_data[a][0];
*** ERROR C72 IN LINE 184 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 184 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  185   4              }
  186   3              
  187   3              // æ›´æ–°å¾ªç¯ç¼“å†²åŒºç´¢å¼•
  188   3              sample_count = (sample_count + 1) % times;
  189   3              
  190   3              // å¯¹æ¯ä¸ªç”µæ„Ÿé€šé“è¿›è¡Œå¤„ç†
  191   3              for(a = 0; a < i_num; a++)
  192   3              {
  193   4                  // åˆ›å»ºä¸´æ—¶æ•°ç»„ç”¨äºæ’åºï¼Œé¿å…ä¿®æ”¹åŸå§‹æ•°æ®
  194   4                  uint16 sort_array[times];
*** ERROR C109 IN LINE 194 OF ..\USER\src\electromagnetic_tracking.c: illegal constant expression
*** ERROR C122 IN LINE 194 OF ..\USER\src\electromagnetic_tracking.c: 'sort_array': unknown size
  195   4                  for(t = 0; t < times; t++)
  196   4                  {
  197   5                      sort_array[t] = adc_fliter_data[a][t];
*** ERROR C72 IN LINE 197 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  198   5                  }
  199   4                  
  200   4                  // å†’æ³¡æ’åº
  201   4                  for(uint16 i = 0; i < times-1; i++)
*** ERROR C25 IN LINE 201 OF ..\USER\src\electromagnetic_tracking.c: syntax error near 'uint16'
  202   4                  {
  203   5                      for(t = 0; t < times-i-1; t++)
  204   5                      {
  205   6                          if(sort_array[t] > sort_array[t+1])
  206   6                          {
  207   7                              temp = sort_array[t];
  208   7                              sort_array[t] = sort_array[t+1];
  209   7                              sort_array[t+1] = temp;
  210   7                          }
  211   6                      }
  212   5                  }
C251 COMPILER V5.60.0,  electromagnetic_tracking                                           29/03/25  23:09:18  PAGE 5   

  213   4                  
  214   4                  // è®¡ç®—ä¸­ä½æ•°ç´¢å¼•
  215   4                  mid_index = times / 2;
  216   4                  
  217   4                  // å–ä¸­ä½æ•°ä½œä¸ºç»“æœ
  218   4                  result[a] = sort_array[mid_index];
  219   4              }
  220   3          }
  221   2      }
  222   1      
  223   1      
  224   1      // æ›´æ–°æ¯ä¸ªç”µæ„Ÿçš„æœ€å¤§æœ€å°å€¼ï¼Œç”¨äºåŠ¨æ€æ ¡å‡†
  225   1      void update_min_max_values(void)
  226   1      {
  227   2          // æ›´æ–°æœ€å°å€¼
  228   2          if(adc_fliter_data[SENSOR_L][0] < min_L && adc_fliter_data[SENSOR_L][0] > 10) min_L = adc_fliter_data
             -[SENSOR_L][0];
*** ERROR C72 IN LINE 228 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 228 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** WARNING C173 IN LINE 228 OF ..\USER\src\electromagnetic_tracking.c: '<': signed/unsigned type mismatch
*** ERROR C72 IN LINE 228 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  229   2          if(adc_fliter_data[SENSOR_LM][0] < min_LM && adc_fliter_data[SENSOR_LM][0] > 10) min_LM = adc_fliter_
             -data[SENSOR_LM][0];
*** ERROR C72 IN LINE 229 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 229 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** WARNING C173 IN LINE 229 OF ..\USER\src\electromagnetic_tracking.c: '<': signed/unsigned type mismatch
*** ERROR C72 IN LINE 229 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  230   2          if(adc_fliter_data[SENSOR_RM][0] < min_RM && adc_fliter_data[SENSOR_RM][0] > 10) min_RM = adc_fliter_
             -data[SENSOR_RM][0];
*** ERROR C72 IN LINE 230 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 230 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** WARNING C173 IN LINE 230 OF ..\USER\src\electromagnetic_tracking.c: '<': signed/unsigned type mismatch
*** ERROR C72 IN LINE 230 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  231   2          if(adc_fliter_data[SENSOR_R][0] < min_R && adc_fliter_data[SENSOR_R][0] > 10) min_R = adc_fliter_data
             -[SENSOR_R][0];
*** ERROR C72 IN LINE 231 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 231 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** WARNING C173 IN LINE 231 OF ..\USER\src\electromagnetic_tracking.c: '<': signed/unsigned type mismatch
*** ERROR C72 IN LINE 231 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  232   2          
  233   2          // æ›´æ–°æœ€å¤§å€¼
  234   2          if(adc_fliter_data[SENSOR_L][0] > max_L) max_L = adc_fliter_data[SENSOR_L][0];
*** ERROR C72 IN LINE 234 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** WARNING C173 IN LINE 234 OF ..\USER\src\electromagnetic_tracking.c: '>': signed/unsigned type mismatch
*** ERROR C72 IN LINE 234 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  235   2          if(adc_fliter_data[SENSOR_LM][0] > max_LM) max_LM = adc_fliter_data[SENSOR_LM][0];
*** ERROR C72 IN LINE 235 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** WARNING C173 IN LINE 235 OF ..\USER\src\electromagnetic_tracking.c: '>': signed/unsigned type mismatch
*** ERROR C72 IN LINE 235 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  236   2          if(adc_fliter_data[SENSOR_RM][0] > max_RM) max_RM = adc_fliter_data[SENSOR_RM][0];
*** ERROR C72 IN LINE 236 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** WARNING C173 IN LINE 236 OF ..\USER\src\electromagnetic_tracking.c: '>': signed/unsigned type mismatch
*** ERROR C72 IN LINE 236 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  237   2          if(adc_fliter_data[SENSOR_R][0] > max_R) max_R = adc_fliter_data[SENSOR_R][0];
*** ERROR C72 IN LINE 237 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** WARNING C173 IN LINE 237 OF ..\USER\src\electromagnetic_tracking.c: '>': signed/unsigned type mismatch
*** ERROR C72 IN LINE 237 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  238   2      }
  239   1      
  240   1      // å½’ä¸€åŒ–ç”µæ„Ÿæ•°æ®
  241   1      void normalize_sensors(void)
  242   1      {
  243   2          // åŠ¨æ€æ ¡å‡†ï¼Œé˜²æ­¢é™¤ä»¥0ï¼Œç¡®ä¿æœ€å¤§å€¼å’Œæœ€å°å€¼æœ‰å·®å¼‚
  244   2          // ä½¿ç”¨1000ä½œä¸ºæ”¾å¤§ç³»æ•°ï¼Œé¿å…ä½¿ç”¨æµ®ç‚¹æ•°
  245   2          if(max_L > min_L) 
  246   2              normalized_L = (float)((adc_fliter_data[SENSOR_L][0] - min_L) * 1000) / ((max_L - min_L) * 1000);
C251 COMPILER V5.60.0,  electromagnetic_tracking                                           29/03/25  23:09:18  PAGE 6   

*** ERROR C72 IN LINE 246 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  247   2          else 
  248   2              normalized_L = 0;
  249   2              
  250   2          if(max_LM > min_LM) 
  251   2              normalized_LM = (float)((adc_fliter_data[SENSOR_LM][0] - min_LM) * 1000) / ((max_LM - min_LM) * 1
             -000);
*** ERROR C72 IN LINE 251 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  252   2          else 
  253   2              normalized_LM = 0;
  254   2              
  255   2          if(max_RM > min_RM) 
  256   2              normalized_RM = (float)((adc_fliter_data[SENSOR_RM][0] - min_RM) * 1000) / ((max_RM - min_RM) * 1
             -000);
*** ERROR C72 IN LINE 256 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  257   2          else 
  258   2              normalized_RM = 0;
  259   2              
  260   2          if(max_R > min_R) 
  261   2              normalized_R = (float)((adc_fliter_data[SENSOR_R][0] - min_R) * 1000) / ((max_R - min_R) * 1000);
*** ERROR C72 IN LINE 261 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  262   2          else 
  263   2              normalized_R = 0;
  264   2          
  265   2          // é™åˆ¶èŒƒå›´åœ¨0-1ä¹‹é—´
  266   2          if(normalized_L > 1.0f) normalized_L = 1.0f;
  267   2          if(normalized_L < 0.0f) normalized_L = 0.0f;
  268   2          
  269   2          if(normalized_LM > 1.0f) normalized_LM = 1.0f;
  270   2          if(normalized_LM < 0.0f) normalized_LM = 0.0f;
  271   2          
  272   2          if(normalized_RM > 1.0f) normalized_RM = 1.0f;
  273   2          if(normalized_RM < 0.0f) normalized_RM = 0.0f;
  274   2          
  275   2          if(normalized_R > 1.0f) normalized_R = 1.0f;
  276   2          if(normalized_R < 0.0f) normalized_R = 0.0f;
  277   2      }
  278   1      
  279   1      // è®¡ç®—ä½ç½®ï¼ˆä½¿ç”¨å·®æ¯”å’ŒåŠ æƒå¹³å‡æ–¹æ³•ï¼‰
  280   1      int16 calculate_position(void)
  281   1      {
  282   2          // åœ¨å‡½æ•°å¼€å§‹å¤„å£°æ˜æ‰€æœ‰å˜é‡
  283   2          float weight_sum = 0;      // æƒé‡æ€»å’Œ
  284   2          float weighted_sum = 0;    // åŠ æƒå’Œç»“æœ
  285   2          float diff_L_R = 0;        // å·¦å³æ°´å¹³ç”µæ„Ÿå·®å€¼
  286   2          float diff_LM_RM = 0;      // å·¦å³ä¸­é—´ç”µæ„Ÿå·®å€¼
  287   2          float sum_L_R = 0;         // å·¦å³æ°´å¹³ç”µæ„Ÿå’Œå€¼
  288   2          float sum_LM_RM = 0;       // å·¦å³ä¸­é—´ç”µæ„Ÿå’Œå€¼
  289   2          static int16 last_pos = 0; // ä¸Šä¸€æ¬¡ä½ç½®å€¼ï¼Œç”¨äºæ»¤æ³¢
  290   2          int16 pos = 0;             // å½“å‰è®¡ç®—å¾—åˆ°çš„ä½ç½®å€¼
  291   2          float filter_param = 0.7f; // æ»¤æ³¢ç³»æ•°ï¼Œå¯è°ƒ
  292   2          
  293   2          // è®¡ç®—æ°´å¹³ç”µæ„Ÿçš„å·®å€¼å’Œå’Œå€¼
  294   2          diff_L_R = normalized_L - normalized_R;
  295   2          sum_L_R = normalized_L + normalized_R;
  296   2          
  297   2          // è®¡ç®—å‚ç›´ç”µæ„Ÿçš„å·®å€¼å’Œå’Œå€¼
  298   2          diff_LM_RM = normalized_LM - normalized_RM;
  299   2          sum_LM_RM = normalized_LM + normalized_RM;
  300   2          
  301   2          // è®¡ç®—å·®æ¯”å’Œï¼Œé¿å…é™¤ä»¥0
  302   2          if(sum_L_R > 0.01f)
  303   2              ratio_L_R = diff_L_R / sum_L_R;
  304   2          else
  305   2              ratio_L_R = 0;
  306   2              
C251 COMPILER V5.60.0,  electromagnetic_tracking                                           29/03/25  23:09:18  PAGE 7   

  307   2          if(sum_LM_RM > 0.01f)
  308   2              ratio_LM_RM = diff_LM_RM / sum_LM_RM;
  309   2          else
  310   2              ratio_LM_RM = 0;
  311   2          
  312   2          // ç‰¹æ®Šæƒ…å†µå¤„ç†ï¼šå½“æ‰€æœ‰ç”µæ„Ÿå€¼éƒ½å¾ˆå°æ—¶ï¼Œå¯èƒ½å·²ç»åç¦»èµ›é“
  313   2          if(sum_L_R < 0.1f && sum_LM_RM < 0.1f)
  314   2          {
  315   3              // ä¿æŒä¸Šä¸€æ¬¡çš„ä½ç½®å€¼
  316   3              return last_pos;
  317   3          }
  318   2          
  319   2          // åå­—è·¯å£ç‰¹å¾ï¼šä¸­é—´ç”µæ„Ÿå€¼å¤§ï¼Œä¸¤ä¾§ç”µæ„Ÿå€¼å°
  320   2          if(normalized_LM > 0.6f && normalized_RM > 0.6f && 
  321   2             normalized_L < 0.3f && normalized_R < 0.3f)
  322   2          {
  323   3              // åå­—è·¯å£å¤„ç†é€»è¾‘ï¼Œä¿æŒç›´è¡Œ
  324   3              return 0;
  325   3          }
  326   2          
  327   2          // å·®æ¯”å’ŒåŠ æƒï¼Œæ°´å¹³ç”µæ„Ÿæƒé‡å¤§ï¼Œå‚ç›´ç”µæ„Ÿæƒé‡å°
  328   2          weighted_sum = ratio_L_R * 100 * 0.7f + ratio_LM_RM * 100 * 0.3f;
  329   2          
  330   2          // é™åˆ¶èŒƒå›´åœ¨-100åˆ°100ä¹‹é—´
  331   2          if(weighted_sum > 100) weighted_sum = 100;
  332   2          if(weighted_sum < -100) weighted_sum = -100;
  333   2          
  334   2          pos = (int16)weighted_sum;
  335   2          
  336   2          // æ·»åŠ ä½é€šæ»¤æ³¢ï¼Œå‡å°‘æŠ–åŠ¨
  337   2          pos = (int16)(filter_param * pos + (1-filter_param) * last_pos);
  338   2          last_pos = pos;
  339   2          
  340   2          return pos;
  341   2      }
  342   1      
  343   1      // ç”µç£ä¿æŠ¤é€»è¾‘å‡½æ•°å®ç°
  344   1      uint8 check_electromagnetic_protection(void)
  345   1      {
  346   2          // åœ¨å‡½æ•°å¼€å§‹å¤„å£°æ˜æ‰€æœ‰å˜é‡
  347   2          uint8 is_out_of_track = 0;    // æ ‡è®°æ˜¯å¦è„±ç¦»èµ›é“çš„æ ‡å¿—ä½
  348   2          uint16 sum_value = 0;         // æ‰€æœ‰ç”µæ„Ÿå€¼çš„æ€»å’Œ
  349   2          uint16 threshold = 100;       // é˜ˆå€¼ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼Œåˆ¤æ–­è„±ç¦»èµ›é“çš„ç”µæ„
             -Ÿæ€»å’Œé˜ˆå€¼
  350   2          static uint8 out_of_track_count = 0;    // è¿ç»­æ£€æµ‹åˆ°è„±ç¦»èµ›é“çš„æ¬¡æ•°è®¡æ•°å™¨
  351   2          static uint8 protection_triggered = 0;  // ä¿æŠ¤è§¦å‘æ ‡å¿—ä½ï¼Œ1è¡¨ç¤ºå·²è§¦å‘ä¿æŠ¤
  352   2          
  353   2          // è®¡ç®—æ‰€æœ‰ç”µæ„Ÿçš„å’Œå€¼
  354   2          sum_value = adc_fliter_data[SENSOR_L][0] + adc_fliter_data[SENSOR_LM][0] + 
  355   2                      adc_fliter_data[SENSOR_RM][0] + adc_fliter_data[SENSOR_R][0];
*** ERROR C72 IN LINE 354 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 354 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 354 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
*** ERROR C72 IN LINE 354 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  356   2          
  357   2          // åˆ¤æ–­æ˜¯å¦è„±ç¦»èµ›é“çš„æ¡ä»¶
  358   2          // 1. æ‰€æœ‰ç”µæ„Ÿå€¼æ€»å’Œè¿‡å°ï¼Œè¯´æ˜å¯èƒ½è„±ç¦»èµ›é“
  359   2          if(sum_value < threshold)
  360   2          {
  361   3              is_out_of_track = 1;
  362   3          }
  363   2          
  364   2          // 2. å½’ä¸€åŒ–åçš„å€¼éƒ½å¾ˆå°ï¼Œè¯´æ˜å¯èƒ½è„±ç¦»èµ›é“
  365   2          if(normalized_L < 0.05f && normalized_LM < 0.05f && 
  366   2             normalized_RM < 0.05f && normalized_R < 0.05f)
  367   2          {
C251 COMPILER V5.60.0,  electromagnetic_tracking                                           29/03/25  23:09:18  PAGE 8   

  368   3              is_out_of_track = 1;
  369   3          }
  370   2          
  371   2          // 3. ä½ç½®åå·®è¿‡å¤§ï¼Œè¯´æ˜å¯èƒ½åç¦»èµ›é“å¤ªå¤š
  372   2          if(position < -90 || position > 90)
  373   2          {
  374   3              // åªæœ‰å½“ç”µæ„Ÿå€¼æ€»å’Œä¹Ÿè¾ƒå°æ—¶æ‰åˆ¤æ–­ä¸ºå‡ºèµ›é“
  375   3              if(sum_value < threshold * 2)
  376   3              {
  377   4                  is_out_of_track = 1;
  378   4              }
  379   3          }
  380   2          
  381   2          // è¿ç»­æ£€æµ‹é€»è¾‘ï¼Œé˜²æ­¢å¶ç„¶çš„ä½å€¼å¯¼è‡´è¯¯åˆ¤
  382   2          if(is_out_of_track)
  383   2          {
  384   3              out_of_track_count++;
  385   3              if(out_of_track_count >= 5)  // è¿ç»­5æ¬¡æ£€æµ‹åˆ°è„±ç¦»èµ›é“æ‰è§¦å‘ä¿æŠ¤
  386   3              {
  387   4                  protection_triggered = 1;
  388   4              }
  389   3          }
  390   2          else
  391   2          {
  392   3              // å¦‚æœæ£€æµ‹æ­£å¸¸ï¼Œåˆ™è®¡æ•°å™¨å‡å°‘ä½†ä¸ä½äº0
  393   3              if(out_of_track_count > 0)
  394   3                  out_of_track_count--;
  395   3          }
  396   2          
  397   2          return protection_triggered;
  398   2      }
  399   1      
  400   1      // æ˜¾ç¤ºç”µç£ä¼ æ„Ÿå™¨æ•°æ®
  401   1      void display_electromagnetic_data(void)
  402   1      {
  403   2          // æ˜¾ç¤ºåŸå§‹æ»¤æ³¢æ•°æ®å’Œå½’ä¸€åŒ–æ•°æ®
  404   2          ips114_showstr(0,0,"L:");   
  405   2          ips114_showuint16(3*8, 0, adc_fliter_data[SENSOR_L][0]);
*** WARNING C122 IN LINE 405 OF ..\USER\src\electromagnetic_tracking.c: '[]': unknown size
*** ERROR C72 IN LINE 405 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  406   2          ips114_showstr(9*8,0,"N:");
  407   2          ips114_showfloat(11*8, 0, normalized_L, 2, 2);
  408   2          
  409   2          ips114_showstr(0,1,"LM:");  
  410   2          ips114_showuint16(3*8, 1, adc_fliter_data[SENSOR_LM][0]);
*** WARNING C122 IN LINE 410 OF ..\USER\src\electromagnetic_tracking.c: '[]': unknown size
*** ERROR C72 IN LINE 410 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  411   2          ips114_showstr(9*8,1,"N:");
  412   2          ips114_showfloat(11*8, 1, normalized_LM, 2, 2);
  413   2          
  414   2          ips114_showstr(0,2,"RM:");  
  415   2          ips114_showuint16(3*8, 2, adc_fliter_data[SENSOR_RM][0]);
*** WARNING C122 IN LINE 415 OF ..\USER\src\electromagnetic_tracking.c: '[]': unknown size
*** ERROR C72 IN LINE 415 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  416   2          ips114_showstr(9*8,2,"N:");
  417   2          ips114_showfloat(11*8, 2, normalized_RM, 2, 2);
  418   2          
  419   2          ips114_showstr(0,3,"R:");   
  420   2          ips114_showuint16(3*8, 3, adc_fliter_data[SENSOR_R][0]);
*** WARNING C122 IN LINE 420 OF ..\USER\src\electromagnetic_tracking.c: '[]': unknown size
*** ERROR C72 IN LINE 420 OF ..\USER\src\electromagnetic_tracking.c: sizeof returns zero
  421   2          ips114_showstr(9*8,3,"N:");
  422   2          ips114_showfloat(11*8, 3, normalized_R, 2, 2);
  423   2          
  424   2          // æ˜¾ç¤ºä½ç½®å’Œå·®æ¯”å’Œæ•°æ®
  425   2          ips114_showstr(0,4,"Pos:");
C251 COMPILER V5.60.0,  electromagnetic_tracking                                           29/03/25  23:09:18  PAGE 9   

  426   2          ips114_showint16(5*8, 4, position);
  427   2          
  428   2          // æ˜¾ç¤ºå·®æ¯”å’Œæ•°æ®
  429   2          ips114_showstr(0,5,"L-R:");
  430   2          ips114_showfloat(5*8, 5, ratio_L_R, 2, 2);
  431   2          
  432   2          ips114_showstr(0,6,"LM-RM:");
  433   2          ips114_showfloat(6*8, 6, ratio_LM_RM, 2, 2);
  434   2      } 

C251 COMPILATION COMPLETE.  12 WARNING(S),  72 ERROR(S)
